<?xml version="1.0" encoding="UTF-8" ?>
<script name="EMA.scriptEMA">
  <label>ScriptEMA</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="input" type="rifp">
      <type>nmeta_com.conceptwave.system.Object</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var fnd = new Finder('EMA.findIMSI');
    var doc = fnd.search();

    var i = 0;
    var output = new DataStructure("EMA.responseEMA");
    var grabarDocumento = new Document("EMA.clienteHLR");


    fnd.searchDocument.MSISDN = input.MSISDN;
    var result = fnd.search();//retorna una DataObjectList() -> ARRAY
    var doc1 = result && result.length>0 ? result[0] : null;

    if(doc1)
    {
          output.mensaje= "Error EMA,  MSISDN " + input.MSISDN + " ya existe";
          output.estado = "NOOK";
          /*doc[i].IMSI = input.IMSI;
          doc[i].PROFILE = input.PROFILE;
          doc[i].save(); */
    }


    fnd.searchDocument.IMSI = input.IMSI;
    var result = fnd.search();//retorna una DataObjectList() -> ARRAY
    var doc2 = result && result.length>0 ? result[0] : null;
    if(doc2)
    {

          output.mensaje= "Error EMA, IMSI " + input.IMSI + " ya existe";
          output.estado = "NOOK";
    }

    if( !doc1 &&  !doc2)
    {
         grabarDocumento.MSISDN = input.MSISDN;
          grabarDocumento.IMSI = input.IMSI;
          grabarDocumento.PROFILE = input.PROFILE;
          grabarDocumento.save();
          output.mensaje= "Plan Asignado a la MSISDN " + input.MSISDN;
          output.estado = "OK";
    }

    return output;



    /*
    var output = new DataStructure("EMA.responseEMA");
    var grabarDocumento = new Document("EMA.clienteHLR");


    grabarDocumento.IMSI = input.IMSI;
    grabarDocumento.MSISDN = input.MSISDN;
    grabarDocumento.PROFILE = input.PROFILE;

    grabarDocumento.save(); output.mensaje= "Ok"; output.estado = "Provisionada la MSISDN " + input.MSISDN;



    return output;

    */
  ]]></script>
</script>