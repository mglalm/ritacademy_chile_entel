<?xml version="1.0" encoding="UTF-8" ?>
<script name="externalSystemBSCS.scr_provServicioBSCS">
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="input" type="rifp">
      <type>dstruct_externalSystemBSCS.input_provServicioBSCS</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var var_orderid = input.orderid;
    var var_rut = input.rut;
    var var_msisdn = input.msisdn;
    var var_id_plan_bscs = input.id_plan_bscs;

    var var_id_cliente2;
    var var_id_cliente_n;
    var var_id_cliente_c;

    var output = new DataStructure("externalSystemBSCS.output_provServicioBSCS");

    //----------------------------------------------------CREAR CLIENTE SI ES QUE NO EXISTE
    externalSystemBSCS.quiebra_ejecucion();
    var clientes_existentes = new Finder("externalSystemBSCS.FIND_SERV_BSCS_CLIENTE");
    var resultado = clientes_existentes.search();
    var existe_cliente = 0;

    if ( resultado.length > 0)
    {
        for (var i=0 ; i < resultado.length ; i++ )
        {
            if (resultado[i].DT_SERV_BSCS_RUT == var_rut && resultado[i].DT_SERV_BSCS_ID_CLIENTE_ESTADO == 1)
            {
                existe_cliente = 1;
                var_id_cliente_n=resultado[i].DT_SERV_BSCS_ID_CLIENTE_N;
                var_id_cliente_c=resultado[i].DT_SERV_BSCS_ID_CLIENTE_C;
            }
            if (resultado[i].DT_SERV_BSCS_RUT == var_rut && resultado[i].DT_SERV_BSCS_ID_CLIENTE_ESTADO == 2)
            {
                //-----CLIENTE EXISTE PERO CON ESTADO SUSPENDIDO, NO SE PUEDEN ACTIVAR NUEVOS SERVICIOS
                output.estado = "NOOK";
                output.mensaje = "No se puede activar servicios ya que el Cliente se encuentra Suspendido";
                return output;
            }
        }
    }

    if ( existe_cliente == 0 )
    {
        //-----CREAR CLIENTE DADO QUE NO EXISTE EN LA BD
        //-----OBTIENE NUEVA SECUENCIA PARA EL SERVICIO
        var doc_secuencia = new Finder("externalSystemBSCS.SEQ_BSCS_ID_CLIENTE");
        var nueva_secuencia = doc_secuencia.search();
        var_id_cliente_n=nueva_secuencia[0].type;  //Obtiene el valor desde el finder
        var fecha_hoy = new Date();
        var documento = new Document("externalSystemBSCS.DOC_SERV_BSCS_CLIENTE");
        var_id_cliente_c=var_id_cliente_n.toString();
        documento.DT_SERV_BSCS_ID_CLIENTE_N=var_id_cliente_n;
        documento.DT_SERV_BSCS_ID_CLIENTE_C=var_id_cliente_c;
        documento.DT_SERV_BSCS_FECHA_CREACION=fecha_hoy;
        documento.DT_SERV_BSCS_ID_CLIENTE_ESTADO=1;
        documento.DT_SERV_BSCS_RUT=var_rut;
        documento.save();
    }
    //else
    //    var_id_cliente=var_id_cliente2;

    //----------------------------------------------------VALIDAR SI EL PLAN EXISTE
    externalSystemBSCS.quiebra_ejecucion();
    var planes_existentes = new Finder("externalSystemBSCS.FIND_SERV_BSCS_PLAN");
    var resultado = planes_existentes.search();
    var existe_plan = 0;

    if ( resultado.length > 0)
    {
        for (var i=0 ; i < resultado.length ; i++ )
        {
            if (resultado[i].DT_SERV_BSCS_ID_PLAN_C == var_id_plan_bscs)
            {
                existe_plan = 1;
                var var_id_plan_bscs_c=resultado[i].DT_SERV_BSCS_ID_PLAN_C;
                var var_id_plan_bscs_n=resultado[i].DT_SERV_BSCS_ID_PLAN_N;
            }
        }
    }
    if ( existe_plan == 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "No Existe ese plan en BSCS";
        return output;
    }

    //----------------------------------------------------VALIDAR SI EL MSISDN ESTA EN ESTADO RESERVADO
    externalSystemBSCS.quiebra_ejecucion();
    var msisdn_existentes = new Finder("externalSystemBSCS.FIND_SERV_BSCS_MSISDN");
    var resultado = msisdn_existentes.search();
    var existe_msisdn = 0;

    if ( resultado.length > 0)
    {
        for (var i=0 ; i < resultado.length ; i++ )
        {
            if (resultado[i].DT_SERV_BSCS_MSISDN == var_msisdn && resultado[i].DT_SERV_BSCS_ID_MSISDN_ESTADO == 2 )
                existe_msisdn = 1;
        }
    }
    if ( existe_msisdn == 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "El MSISDN no se encuentra en estado RESERVADO";
        return output;
    }

    //REGISTRAR SERVICIO y LUEGO CAMBIAR ESTADO DE MSISDN a ASIGNADO
    //-----VALIDAR SI MSISDN/CLIENTE NO TIENEN EL SERVICIO ACTIVO
    externalSystemBSCS.quiebra_ejecucion();
    var servicios_existentes = new Finder("externalSystemBSCS.FIND_SERV_BSCS_SERVICIOS_VIGENTES");
    var resultado = servicios_existentes.search();
    var existe_servicio = 0;

    if ( resultado.length > 0)
    {
        for (var i=0 ; i < resultado.length ; i++ )
        {
            if (resultado[i].DT_SERV_BSCS_MSISDN == var_msisdn && resultado[i].DT_SERV_BSCS_ID_SERVICIO_ESTADO == 1 )
                existe_servicio = 1;
        }
    }
    if ( existe_servicio > 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "El MSISDN se encuentra Activo en un Servicio";
        return output;
    }


    //----------------------------------------------------SE ACTIVAN LOS SERVICIOS
    externalSystemBSCS.quiebra_ejecucion();
    //-----OBTIENE NUEVA SECUENCIA PARA EL SERVICIO
    var doc_secuencia = new Finder("externalSystemBSCS.SEQ_BSCS_ID_SERVICIO");
    var nueva_secuencia = doc_secuencia.search();
    var var_id_servicio_n=nueva_secuencia[0].type;  //Obtiene el valor desde el finder
    var var_id_servicio_c=var_id_servicio_n.toString();

    var fecha_hoy = new Date();
    var documento = new Document("externalSystemBSCS.DOC_SERV_BSCS_SERVICIOS_VIGENTES");
    documento.DT_SERV_BSCS_ID_SERVICIO_N=var_id_servicio_n;
    documento.DT_SERV_BSCS_ID_SERVICIO_C=var_id_servicio_c;
    documento.DT_SERV_BSCS_ID_CLIENTE_N=var_id_cliente_n;
    documento.DT_SERV_BSCS_ID_CLIENTE_C=var_id_cliente_c;
    documento.DT_SERV_BSCS_MSISDN=var_msisdn;
    documento.DT_SERV_BSCS_ID_PLAN_C=var_id_plan_bscs_c;
    documento.DT_SERV_BSCS_ID_PLAN_N=var_id_plan_bscs_n;
    documento.DT_SERV_BSCS_ORDER_ID=var_orderid;
    documento.DT_SERV_BSCS_ID_SERVICIO_ESTADO=1;
    documento.DT_SERV_BSCS_FECHA_ACTIVACION=fecha_hoy;
    documento.DT_SERV_BSCS_FECHA_ACTUALIZACION=fecha_hoy;
    documento.save();

    //-----CAMBIAMOS EL ESTADO DEL MSISDN A ASIGNADO
    externalSystemBSCS.quiebra_ejecucion();
    var msisdn_existentes = new Finder("externalSystemBSCS.FIND_SERV_BSCS_MSISDN");
    var resultado = msisdn_existentes.search();
    var existe_msisdn = 0;

    if ( resultado.length > 0)
    {
        for (var i=0 ; i < resultado.length ; i++ )
        {
            if (resultado[i].DT_SERV_BSCS_MSISDN == var_msisdn && resultado[i].DT_SERV_BSCS_ID_MSISDN_ESTADO == 2 )
            {
                existe_msisdn = 1;
                resultado[i].DT_SERV_BSCS_ID_MSISDN_ESTADO = 3;
                resultado[i].save();
            }
        }
    }

    output.estado = "OK";
    output.mensaje = "Servicio Provisionado en BSCS";

    return output;
  ]]></script>
</script>