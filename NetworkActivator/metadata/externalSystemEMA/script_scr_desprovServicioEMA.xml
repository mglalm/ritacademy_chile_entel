<?xml version="1.0" encoding="UTF-8" ?>
<script name="externalSystemEMA.scr_desprovServicioEMA">
  <label>Binding Script EMA</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="input" type="rifp">
      <type>dstruct_externalSystemEMA.input_desprovServicioEMA</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var var_msisdn = input.msisdn;
    var var_id_servicio_estado = 3;  // ESTADO DESACTIVADO
    var var_id_servicio;

    externalSystemEMA.quiebra_ejecucion();

    var output = new DataStructure("externalSystemEMA.output_desprovServicioEMA");

    //-----VERIFICAR QUE TENGA ACTIVO EL SERVICIO
    var listado_servicios = new Finder("externalSystemEMA.DOC_SERVICIO_EMA_FIND");
    var resultado = listado_servicios.search();
    var ya_tiene_servicio = 0 ;
    if ( resultado.length > 0)
    {
        for ( var i = 0 ; i < resultado.length ; i++ )
        {
            if ( resultado[i].ID_ESTADO_SERVICIO_EMA == 1 && resultado[i].MSISDN_SERVICIO_EMA == var_msisdn )
            {
                //-----SI LO ENCUENTRA LO DEJA EN ESTADO DESACTIVO
                ya_tiene_servicio = 1;
                var_id_servicio=resultado[i].ID_PROFILE_SERVICIO_EMA;
                resultado[i].ID_ESTADO_SERVICIO_EMA=var_id_servicio_estado;
                //resultado[i].saveToDB();
                resultado[i].save();
            }
        }
    }
    if ( ya_tiene_servicio == 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "Ese Movil no tiene Servicio Activo en EMA";
        return output;
    }


    //-----ELIMINA SALDOS
    var listado_nodos = new Finder("externalSystemEMA.DOC_SERV_NOD_EMA_FIND");
    var resultado = listado_nodos.search();
    if ( resultado.length > 0)
    {
        for ( var i = 0 ; i < resultado.length ; i++ )
        {
            if ( resultado[i].MSISDN_SERVICIO_EMA == var_msisdn )
            {
                //-----SI LO ENCUENTRA ELIMINA EL REGISTRO
                resultado[i].deleteItem();
    //            var_id_servicio=resultado[i].ID_SERVICIO_SERVICO_CS;
    //            resultado[i].ID_SERVICIO_ESTADO_SERVICO_CS=var_id_servicio_estado;

            }
        }
    }

    output.estado = "OK";
    output.mensaje = "Servicio desprovisionado en EMA";

    return output;
  ]]></script>
</script>