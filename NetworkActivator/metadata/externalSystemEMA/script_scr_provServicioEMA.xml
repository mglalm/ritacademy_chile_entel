<?xml version="1.0" encoding="UTF-8" ?>
<script name="externalSystemEMA.scr_provServicioEMA">
  <label>Binding Script EMA</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="input" type="rifp">
      <type>dstruct_externalSystemEMA.input_provServicioEMA</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var var_orderid = input.orderid;
    var var_msisdn = input.msisdn;
    var var_profile = input.id_profile;
    var var_estado = 1;
    var output = new DataStructure("externalSystemEMA.output_provServicioEMA");

    externalSystemEMA.quiebra_ejecucion();

    //-----VALIDANDO SI EXISTE EL PROFILE QUE SE RECIBE COMO PARAMETRO
    var perfiles_activos = new Finder("externalSystemEMA.DOC_PROFILE_EMA_FIND");
    var resultado = perfiles_activos.search();

    var existe_profile = 0 ;
    if ( resultado.length > 0 )
    {
        for (var i=0 ;    i < resultado.length ; i++ )
        {
            if (resultado[i].ID_PROFILE_SERVICIO_EMA == var_profile )
                existe_profile = 1;
        }
    }
    if ( existe_profile == 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "No existe Profile en EMA";
        return output;
    }

    //-----VALIDANDO SI EL PERFIL TIENE PLATAFORMAS CONFIGURADAS PARA LA ACTIVACION
    var perfiles_nodos_activos = new Finder("externalSystemEMA.DOC_PROF_DETALLE_EMA_FIND");
    var resultado = perfiles_nodos_activos.search();

    var existe_profile_nodo = 0 ;
    if ( resultado.length > 0 )
    {
        for (var i=0 ;    i < resultado.length ; i++ )
        {
            if (resultado[i].ID_PROFILE_SERVICIO_EMA == var_profile )
                existe_profile_nodo = 1;
        }
    }
    if ( existe_profile_nodo == 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "No existen Nodos Configurados para ese Profile en EMA";
        return output;
    }


    //-----VALIDANDO SI LA TRIPLETA YA TIENEN SERVICIO ACTIVO
    var servicios_activos = new Finder("externalSystemEMA.DOC_SERVICIO_EMA_FIND");
    var resultado = servicios_activos.search();
    var ya_tiene_servicio = 0 ;
    if ( resultado.length > 0 )
    {
        for (var i=0 ;    i < resultado.length ; i++ )
        {
            if (resultado[i].ID_PROFILE_SERVICIO_EMA == var_profile && resultado[i].ID_ESTADO_SERVICIO_EMA == var_estado && resultado[i].MSISDN_SERVICIO_EMA == var_msisdn)
                ya_tiene_servicio = 1;
        }
    }
    if ( ya_tiene_servicio > 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "El movil ya tiene ese Profile Activo en EMA";
        return output;
    }

    //-----DADO QUE SE PASARON TODAS LAS VALIDACIONES SE CREA EL SERVICIO, RESTA ACTIVAR LOS NODOS
    var documento = new Document("externalSystemEMA.DOC_SERVICIO_GET_EMA");
    var fecha_hoy = new Date();
    documento.MSISDN_SERVICIO_EMA = var_msisdn;
    documento.ID_PROFILE_SERVICIO_EMA = var_profile;
    documento.ID_ESTADO_SERVICIO_EMA = var_estado;
    documento.FECHA_ACTIVACION_SERVICIO_EMA = fecha_hoy;
    documento.ORDER_ID_SERVICIO_EMA = var_orderid;
    documento.save();


    //-----FALTA SOLO DEJAR EL REGISTRO EN LOS NODOS CORRESPONDIENTES
    var perfiles_nodos_activos = new Finder("externalSystemEMA.DOC_PROF_DETALLE_EMA_FIND");
    var resultado = perfiles_nodos_activos.search();

    var existe_profile_nodo = 0 ;
    var var_id_nodo;
    if ( resultado.length > 0 )
    {
        for (var i=0 ;    i < resultado.length ; i++ )
        {
            if (resultado[i].ID_PROFILE_SERVICIO_EMA == var_profile )
            {
               //-----SE INSERTA REGISTRO EN TABLA DE ACTIVACION DE NODOS
                var_id_nodo=resultado[i].ID_NODO_SERVICIO_EMA;
                var documento = new Document("externalSystemEMA.DOC_SERVICIO_NOD_ACT_GET_EMA");
                documento.ID_NODO_SERVICIO_EMA = var_id_nodo;
                documento.MSISDN_SERVICIO_EMA = var_msisdn
                documento.FECHA_ACTIVACION_SERVICIO_EMA = fecha_hoy;
                documento.save();
            }
        }
    }

    output.estado = "OK";
    output.mensaje = "Servicio Activado en EMA";

    return output;
  ]]></script>
</script>