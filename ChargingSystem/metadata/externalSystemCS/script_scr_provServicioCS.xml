<?xml version="1.0" encoding="UTF-8" ?>
<script name="externalSystemCS.scr_provServicioCS">
  <label>Binding Script CS</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="input" type="rifp">
      <type>dstruct_externalSystemCS.input_provServicioCS</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    var var_orderid = input.orderid;
    var var_idplancs = input.id_plan_cs;
    var var_msisdn = input.msisdn;
    var var_id_servicio_estado = 1;
    var var_id_servicio = 1;
    var var_saldo_inicial;

    externalSystemCS.quiebra_ejecucion();

    var output = new DataStructure("externalSystemCS.output_provServicioCS");

    //-----VALIDANDO SI EXISTE EL PLAN QUE SE RECIBE COMO PARAMETRO
    var planes_activos = new Finder("externalSystemCS.DOC_PLAN_CS_FIND");
    var resultado = planes_activos.search();

    var existe_plan = 0 ;
    if ( resultado.length > 0 )
    {
        for (var i=0 ;    i < resultado.length ; i++ )
        {
            if (resultado[i].ID_PLAN_SERVICIO_CS == var_idplancs )
            {
                existe_plan = 1;
                var_saldo_inicial=resultado[i].SALDO_INICIAL_SERVICIO_CS;
            }
        }
    }
    if ( existe_plan == 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "No existe Plan en Charging";
        return output;
    }


    //-----VERIFICAR QUE NO TENGA ACTIVO PREVIAMENTE EL SERVICIO
    var listado_servicios = new Finder("externalSystemCS.DOC_SERVICIO_CS_FIND");
    var resultado = listado_servicios.search();
    var ya_tiene_servicio = 0 ;
    if ( resultado.length > 0)
    {
        for ( var i = 0 ; i < resultado.length ; i++ )
        {
            if ( resultado[i].ID_SERVICIO_ESTADO_SERVICO_CS == var_id_servicio_estado && resultado[i].MSISDN_SERVICIO_CS == var_msisdn )
                ya_tiene_servicio = 1;
        }
    }
    if ( ya_tiene_servicio > 0 )
    {
        output.estado = "NOOK";
        output.mensaje = "Ese Movil ya tiene Servicio Activo en Charging";
        return output;
    }


    //-----OBTIENE NUEVA SECUENCIA PARA EL SERVICIO
    var doc_secuencia = new Finder("externalSystemCS.SEQ_ID_SERVICIO_CS");
    var nueva_secuencia = doc_secuencia.search();
    var_id_servicio=nueva_secuencia[0].type;  //Obtiene el valor desde el finder

    //-----SE ACTIVAN LOS SERVICIOS
    externalSystemCS.quiebra_ejecucion();
    var fecha_hoy = new Date();
    var documento = new Document("externalSystemCS.DOC_SERVICIO_SERVICIO_GET");
    documento.ID_SERVICIO_SERVICO_CS=var_id_servicio;
    documento.ID_PLAN_SERVICIO_CS=var_idplancs;
    documento.MSISDN_SERVICIO_CS=var_msisdn;
    documento.ID_SERVICIO_ESTADO_SERVICO_CS=var_id_servicio_estado;
    documento.ORDER_ID_SERVICIO_CS=var_orderid;
    documento.FECHA_ACTIVACION_SERVICIO_CS=fecha_hoy;
    documento.save();

    //-----SE ACTIVA EL SALDO INICIAL

    var fecha_hoy = new Date();
    var documento = new Document("externalSystemCS.DOC_SALDOS_SERVICIO_GET_CS");

    documento.ID_SERVICIO_SERVICO_CS=var_id_servicio;
    documento.SALDO_INICIAL_SERVICIO_CS=var_saldo_inicial;
    documento.SALDO_ACTUAL_SERVICIO_CS=var_saldo_inicial;
    documento.FECHA_ULTIMO_SALDO_SERVICIO_CS=fecha_hoy;
    documento.save();

    output.estado = "OK";
    output.mensaje = "Servicio Configurado en Charging";

    return output;
  ]]></script>
</script>