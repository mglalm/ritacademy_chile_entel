<?xml version="1.0" encoding="UTF-8" ?>
<process name="OrderManager.OMProvisionProcess">
  <activity name="inicio" type="seqActivity">
    <label>inicio</label>
    <x>29.0</x>
    <y>100.0</y>
    <childList>
      <child name="rescataParamCS" type="scriptActivity">
        <label>validaParamCS</label>
        <x>11.0</x>
        <y>224.0</y>
        <methodList>
          <method name="cwOnProcActBefore" type="action">
            <category>before</category>
            <system>true</system>
            <script><![CDATA[
              //OrderManager.debug();

              /*
               * En este script se rescatan los parametros desde base de datos para provisionar
               */

              //Inicializa las variables de control, que indican si hay algun problema en el flujo. Quedan en el processDocument.
              OrderManager.inicializaVariableControl(this.process.processDocument);


              // Primero rescato el parámetro para envío a CS
              var parametro = new Document("OrderManager.docOMParametrosNodos");  //documento asociado a la tabla de BD OM_PARAMETROS_NODOS
              var fnd = new Finder("OrderManager.finOM_Parametros_Nodos"); // finder del OM_PARAMETROS_NODOS
              var resultOM_Par; //lista que retornara el finder

              parametro.POId = this.process.processDocument.IN_POIdBasico;
              //parametro.idNodo = "CS";
              //parametro.idParametro = "ID_PLAN_CS";

              var resultOM_Par = fnd.search(resultOM_Par, parametro);//retorna una DataObjectList() -> ARRAY
              var doc = resultOM_Par && resultOM_Par.length>0 ? resultOM_Par[0] : null;

              if(this.process.processDocument.IN_tipoOrden != "PROVISION"){
                  this.process.processDocument.CTRL_ERROR = "13";
                  this.process.processDocument.CTRL_DESC_ERROR = "El tipo de orden ingresada al proceso de provisión no es del tipo correcto. Tipo: " + this.process.processDocument.IN_tipoOrden + ". Debería ser PROVISION.";
                  this.process.processDocument.OUT_estadoOrden = "ErrorParamProvision";
                  return;
              }



              //Si no lo encuentra en BD, debe entregar ERROR, ya que siempre debe encontrarse el plan que se requiere provisionar
              if(!doc){
                  this.process.processDocument.CTRL_ERROR = "4";
                  this.process.processDocument.CTRL_DESC_ERROR = "No se encuentran los parámetros de provisión en BD para la PO ingresada";
                  this.process.processDocument.OUT_estadoOrden = "ErrorParamProvision";
                  return;
              }

              var i=0;
              var hayCS=false, hayBSCS=false, hayEMA = false;

              for(i=0;i<resultOM_Par.length;i++){
                  doc = resultOM_Par[i];
                  if(doc.idNodo == "CS" && doc.idParametro == "ID_PLAN_CS"){
                      this.process.processDocument.CTRL_planCS = doc.valor;
                      hayCS = true;
                  }
                  if(doc.idNodo == "BSCS" && doc.idParametro == "ID_PLAN_BSCS"){
                      this.process.processDocument.CTRL_planBSCS = doc.valor;
                      hayBSCS = true;
                  }
                  if(doc.idNodo == "EMA" && doc.idParametro == "PROFILE"){
                      this.process.processDocument.CTRL_profile = doc.valor;
                      hayEMA = true;
                  }
              }

              if(!hayCS){
                  this.process.processDocument.CTRL_ERROR = "5";
                  this.process.processDocument.CTRL_DESC_ERROR = "No se encuentra el código de plan de CS para la PO ingresada en la configuración de OM";
                  this.process.processDocument.OUT_estadoOrden = "ErrorParamCS";
                  return;
              }
              if(!hayBSCS){
                  this.process.processDocument.CTRL_ERROR = "6";
                  this.process.processDocument.CTRL_DESC_ERROR = "No se encuentra el código de plan de BSCS para la PO ingresada en la configuración de OM";
                   this.process.processDocument.OUT_estadoOrden = "ErrorParamBSCS";
                  return;
              }
              if(!hayEMA){
                  this.process.processDocument.CTRL_ERROR = "7";
                  this.process.processDocument.CTRL_DESC_ERROR = "No se encuentra el código de profile de EMA para la PO ingresada en la configuración de OM";
                   this.process.processDocument.OUT_estadoOrden = "ErrorParamEMA";
                  return;
              }
            ]]></script>
          </method>
        </methodList>
      </child>
      <child name="parametrosOK" type="switchActivity">
        <label>parametrosOK</label>
        <x>63.0</x>
        <y>330.0</y>
        <childList>
          <child name="ok" type="caseActivity">
            <label>ok</label>
            <x>232.0</x>
            <y>332.0</y>
            <childList>
              <child name="obtenerMSISDN" type="opActivity">
                <element>iface_BSCSNamespace.interface_serviciosBSCS/oper_getMsisdnReserveBSCS</element>
                <label>obtenerMSISDN</label>
                <participant>part_BSCSNamespace.billingParticipant</participant>
                <x>125.0</x>
                <y>103.0</y>
                <childList>
                  <child name="validaOrden" type="switchActivity">
                    <label>validaOrden</label>
                    <x>311.0</x>
                    <y>97.0</y>
                    <childList>
                      <child name="nok" type="caseActivity">
                        <label>nok</label>
                        <x>232.0</x>
                        <y>229.0</y>
                        <childList>
                          <child name="seqNotificar" type="seqActivity">
                            <label>seqNotificar</label>
                            <x>259.0</x>
                            <y>233.0</y>
                            <childList>
                              <child name="notificarError" type="scriptActivity">
                                <label>notificarError</label>
                                <x>249.0</x>
                                <y>329.0</y>
                                <methodList>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      OrderManager.debug();

                                      OrderManager.notificaErrorEnProceso(this.process.processDocument);

                                      return;
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                              <child name="ordenNoCompletada" type="completeActivity">
                                <label>ordenNoCompletada</label>
                                <x>230.0</x>
                                <y>431.0</y>
                              </child>
                            </childList>
                          </child>
                        </childList>
                      </child>
                      <child name="ok" type="caseActivity">
                        <label>ok</label>
                        <x>392.0</x>
                        <y>225.0</y>
                        <childList>
                          <child name="provBSCS" type="seqActivity">
                            <label>provBSCS</label>
                            <x>392.0</x>
                            <y>225.0</y>
                            <childList>
                              <child name="provBSCS" type="opActivity">
                                <element>iface_BSCSNamespace.interface_serviciosBSCS/oper_provServicioBSCS</element>
                                <label>provBSCS</label>
                                <participant>part_BSCSNamespace.billingParticipant</participant>
                                <x>488.0</x>
                                <y>105.0</y>
                                <childList>
                                  <child name="provBSCSOK" type="switchActivity">
                                    <label>provBSCSOK</label>
                                    <x>614.0</x>
                                    <y>104.0</y>
                                    <childList>
                                      <child name="ok" type="caseActivity">
                                        <label>ok</label>
                                        <x>614.0</x>
                                        <y>195.0</y>
                                        <childList>
                                          <child name="provCS" type="seqActivity">
                                            <label>provCS</label>
                                            <x>689.0</x>
                                            <y>228.0</y>
                                            <childList>
                                              <child name="provCS" type="opActivity">
                                                <element>iface_CSProvisionInterface.interface_serviciosCS/oper_provServicioCS</element>
                                                <label>provCS</label>
                                                <participant>part_CSProvisionInterface.CSParticipant</participant>
                                                <x>790.0</x>
                                                <y>98.0</y>
                                                <childList>
                                                  <child name="provOK" type="switchActivity">
                                                    <label>provCSOK</label>
                                                    <x>948.0</x>
                                                    <y>96.0</y>
                                                    <childList>
                                                      <child name="nok" type="caseActivity">
                                                        <label>nok</label>
                                                        <x>536.0</x>
                                                        <y>227.0</y>
                                                        <childList>
                                                          <child name="seqNotificar" type="seqActivity">
                                                            <label>seqNotificar</label>
                                                            <x>894.0</x>
                                                            <y>221.0</y>
                                                            <childList>
                                                              <child name="notificarError" type="scriptActivity">
                                                                <label>notificarError</label>
                                                                <x>890.0</x>
                                                                <y>317.0</y>
                                                                <methodList>
                                                                  <method name="cwOnProcActBefore" type="action">
                                                                    <category>before</category>
                                                                    <system>true</system>
                                                                    <script><![CDATA[
                                                                      OrderManager.debug();

                                                                      OrderManager.notificaErrorEnProceso(this.process.processDocument);

                                                                      return;
                                                                    ]]></script>
                                                                  </method>
                                                                </methodList>
                                                              </child>
                                                              <child name="ordenNoCompletada" type="completeActivity">
                                                                <label>ordenNoCompletada</label>
                                                                <x>868.0</x>
                                                                <y>418.0</y>
                                                              </child>
                                                            </childList>
                                                          </child>
                                                        </childList>
                                                      </child>
                                                      <child name="ok" type="caseActivity">
                                                        <label>ok</label>
                                                        <x>1062.0</x>
                                                        <y>231.0</y>
                                                        <childList>
                                                          <child name="provEMA" type="seqActivity">
                                                            <label>provEMA</label>
                                                            <x>1062.0</x>
                                                            <y>231.0</y>
                                                            <childList>
                                                              <child name="provEMA" type="opActivity">
                                                                <element>iface_EMANamespace.interface_serviciosEMA/oper_provServicioEMA</element>
                                                                <label>provEMA</label>
                                                                <participant>part_EMANamespace.EMAParticipant</participant>
                                                                <x>1128.0</x>
                                                                <y>99.0</y>
                                                                <childList>
                                                                  <child name="provisionEMAOK" type="switchActivity">
                                                                    <label>provisionEMAOK</label>
                                                                    <x>1260.0</x>
                                                                    <y>99.0</y>
                                                                    <childList>
                                                                      <child name="ok" type="caseActivity">
                                                                        <label>ok</label>
                                                                        <x>1399.0</x>
                                                                        <y>240.0</y>
                                                                        <childList>
                                                                          <child name="notificarAlOrderEntry" type="seqActivity">
                                                                            <label>notificarAlOrderEntry</label>
                                                                            <x>1394.0</x>
                                                                            <y>226.0</y>
                                                                            <childList>
                                                                              <child name="notificaOE" type="opActivity">
                                                                                <element>iface_OENamespace.recibeFinalOM/oper_OE_Ope_recibe_PROV</element>
                                                                                <label>notificaOE</label>
                                                                                <participant>part_OENamespace.OE_Participant</participant>
                                                                                <x>1494.0</x>
                                                                                <y>97.0</y>
                                                                                <childList>
                                                                                  <child name="notificacionOK" type="switchActivity">
                                                                                    <label>notificacionOK</label>
                                                                                    <x>1647.0</x>
                                                                                    <y>99.0</y>
                                                                                    <childList>
                                                                                      <child name="ok" type="caseActivity">
                                                                                        <label>ok</label>
                                                                                        <x>1647.0</x>
                                                                                        <y>199.0</y>
                                                                                        <childList>
                                                                                          <child name="ordenProvisionadaCorrectamente" type="completeActivity">
                                                                                            <label>ordenProvisionadaCorrectamente</label>
                                                                                            <x>1740.0</x>
                                                                                            <y>197.0</y>
                                                                                          </child>
                                                                                        </childList>
                                                                                        <methodList>
                                                                                          <method name="cwOnProcActCond" type="action">
                                                                                            <category>cond</category>
                                                                                            <system>true</system>
                                                                                            <script><![CDATA[
                                                                                              return this.process.processDocument.CTRL_NotificacionOK == "0";
                                                                                            ]]></script>
                                                                                          </method>
                                                                                        </methodList>
                                                                                      </child>
                                                                                      <child name="nok" type="caseActivity">
                                                                                        <label>nok</label>
                                                                                        <x>1647.0</x>
                                                                                        <y>199.0</y>
                                                                                        <childList>
                                                                                          <child name="reintentarNotificacion" type="seqActivity">
                                                                                            <label>reintentarNotificacion</label>
                                                                                            <x>1597.0</x>
                                                                                            <y>204.0</y>
                                                                                            <childList>
                                                                                              <child name="enviarNotificacion" type="scriptActivity">
                                                                                                <label>enviarNotificacion</label>
                                                                                                <x>1605.0</x>
                                                                                                <y>301.0</y>
                                                                                                <methodList>
                                                                                                  <method name="cwOnProcActBefore" type="action">
                                                                                                    <category>before</category>
                                                                                                    <system>true</system>
                                                                                                    <script><![CDATA[
                                                                                                      //Aqui en realidad se debería reintentar la notificacion al OE
                                                                                                    ]]></script>
                                                                                                  </method>
                                                                                                </methodList>
                                                                                              </child>
                                                                                              <child name="notificacionNoEnviada" type="completeActivity">
                                                                                                <label>notificacionNoEnviada</label>
                                                                                                <x>1591.0</x>
                                                                                                <y>402.0</y>
                                                                                              </child>
                                                                                            </childList>
                                                                                          </child>
                                                                                        </childList>
                                                                                      </child>
                                                                                    </childList>
                                                                                  </child>
                                                                                </childList>
                                                                                <methodList>
                                                                                  <method name="cwOnProcActBefore" type="action">
                                                                                    <category>before</category>
                                                                                    <system>true</system>
                                                                                    <script><![CDATA[
                                                                                      OrderManager.debug();

                                                                                      /** En esta sección, se deben completar los parámetros de entrada a la llamada del WS de
                                                                                       *    notificación del OE.
                                                                                       *
                                                                                       * Si llegó a este punto del proceso, significa que la provision fue exitosa, por lo que se
                                                                                       * competan los estados de la orden en "OK" y se graba en base de datos. Porterior a eso, se genera
                                                                                       * la respuesta al OE.
                                                                                       *
                                                                                       */


                                                                                      this.process.processDocument.OUT_estadoOrden = "0";
                                                                                      this.process.processDocument.OUT_EstadoPOBasica = "0";
                                                                                      this.process.processDocument.OUT_MotivoEstadoPOBasica = "PO " + this.process.processDocument.IN_POIdBasico + " provisionada exitosamente";
                                                                                      // si viene una PO adicional
                                                                                      if(this.process.processDocument.IN_POIdAdicional != null && this.process.processDocument.IN_POIdAdicional.length > 0){
                                                                                          this.process.processDocument.OUT_EstadoPOAdicional = "0";
                                                                                          this.process.processDocument.OUT_MotivoEstadoPOAdicional = "PO " + this.process.processDocument.IN_POIdAdicional + " provisionada exitosamente";
                                                                                      }

                                                                                      //OrderManager.actualizaEstadoOrden(this.process.processDocument.IN_orderId, "ErrorEMA", "Error 11: Error al provisionar en EMA. EMA responde: " + resp.mensaje, "", this.process.processDocument.IN_POIdBasico);
                                                                                      OrderManager.actualizaEstadoOrden(this.process.processDocument.IN_orderId, "Provisionada", "Orden provisionada correctamente", "", "");

                                                                                      this.activityData.orderId = this.process.processDocument.IN_orderId;
                                                                                      this.activityData.rut = this.process.processDocument.IN_rut;
                                                                                      this.activityData.estadoOrden = this.process.processDocument.OUT_estadoOrden;
                                                                                      this.activityData.MSISDN = this.process.processDocument.OUT_MSISDN;
                                                                                      this.activityData.POIdBasica = this.process.processDocument.IN_POIdBasico;
                                                                                      this.activityData.estadoPOBasica = this.process.processDocument.OUT_EstadoPOBasica;
                                                                                      this.activityData.motivoEstadoPOBasica = this.process.processDocument.OUT_MotivoEstadoPOBasica;
                                                                                      this.activityData.POIdAdicional = this.process.processDocument.IN_POIdAdicional;
                                                                                      this.activityData.estadoPOAdicional = this.process.processDocument.OUT_EstadoPOAdicional;
                                                                                      this.activityData.motivoEstadoPOAdicional = this.process.processDocument.OUT_MotivoEstadoPOAdicional;

                                                                                      var POCliente = new Document("OrderManager.docOMPOCliente");

                                                                                      POCliente.POId = this.process.processDocument.IN_POIdBasico;
                                                                                      POCliente.estado = "ACTIVO";
                                                                                      POCliente.rut = this.process.processDocument.IN_rut;
                                                                                      POCliente.MSISDN = this.process.processDocument.OUT_MSISDN;

                                                                                      POCliente.save();


                                                                                      var a = 1;
                                                                                    ]]></script>
                                                                                  </method>
                                                                                  <method name="cwOnProcActAfter" type="action">
                                                                                    <category>script</category>
                                                                                    <system>true</system>
                                                                                    <script><![CDATA[
                                                                                      OrderManager.debug();
                                                                                      var resp = this.activityData;

                                                                                      if(resp.estado = "OK"){
                                                                                          this.process.processDocument.CTRL_NotificacionOK = true;
                                                                                      }
                                                                                      else{
                                                                                          this.process.processDocument.CTRL_NotificacionOK = false;
                                                                                      }

                                                                                      var a = 1;
                                                                                    ]]></script>
                                                                                  </method>
                                                                                </methodList>
                                                                              </child>
                                                                            </childList>
                                                                          </child>
                                                                        </childList>
                                                                        <methodList>
                                                                          <method name="cwOnProcActCond" type="action">
                                                                            <category>cond</category>
                                                                            <system>true</system>
                                                                            <script><![CDATA[
                                                                              return this.process.processDocument.CTRL_ERROR == "0";
                                                                            ]]></script>
                                                                          </method>
                                                                        </methodList>
                                                                      </child>
                                                                      <child name="nok" type="caseActivity">
                                                                        <label>nok</label>
                                                                        <x>1280.0</x>
                                                                        <y>208.0</y>
                                                                        <childList>
                                                                          <child name="seqNotificar" type="seqActivity">
                                                                            <label>seqNotificar</label>
                                                                            <x>1192.0</x>
                                                                            <y>224.0</y>
                                                                            <childList>
                                                                              <child name="notificarError" type="scriptActivity">
                                                                                <label>notificarError</label>
                                                                                <x>1181.0</x>
                                                                                <y>311.0</y>
                                                                                <methodList>
                                                                                  <method name="cwOnProcActBefore" type="action">
                                                                                    <category>before</category>
                                                                                    <system>true</system>
                                                                                    <script><![CDATA[
                                                                                      OrderManager.debug();

                                                                                      OrderManager.notificaErrorEnProceso(this.process.processDocument);

                                                                                      return;
                                                                                    ]]></script>
                                                                                  </method>
                                                                                </methodList>
                                                                              </child>
                                                                              <child name="ordenNoCompletada" type="completeActivity">
                                                                                <label>ordenNoCompletada</label>
                                                                                <x>1163.0</x>
                                                                                <y>417.0</y>
                                                                              </child>
                                                                            </childList>
                                                                          </child>
                                                                        </childList>
                                                                      </child>
                                                                    </childList>
                                                                  </child>
                                                                </childList>
                                                                <methodList>
                                                                  <method name="cwOnProcActBefore" type="action">
                                                                    <category>before</category>
                                                                    <system>true</system>
                                                                    <script><![CDATA[
                                                                      //OrderManager.debug();

                                                                      /** En esta sección, se deben completar los parámetros de entrada a la llamada del WS de provisión
                                                                       *    de EMA. En este caso, se requiere el MSISDN solamente.
                                                                       */

                                                                      this.activityData.orderid = this.process.processDocument.IN_orderId;
                                                                      this.activityData.msisdn = this.process.processDocument.OUT_MSISDN;
                                                                      this.activityData.id_profile = this.process.processDocument.CTRL_profile;

                                                                      var a = 1;
                                                                    ]]></script>
                                                                  </method>
                                                                  <method name="cwOnProcActAfter" type="action">
                                                                    <category>script</category>
                                                                    <system>true</system>
                                                                    <script><![CDATA[
                                                                      //OrderManager.debug();
                                                                      //Inicializa las variables de control, que indican si hay algun problema en el flujo. Quedan en el processDocument.
                                                                      var docProc = this.process.processDocument;
                                                                      OrderManager.inicializaVariableControl(this.process.processDocument);

                                                                      //resp contiene el resultado del WS, con la respuesta de la activación en EMA
                                                                      var resp = this.activityData;

                                                                      var prov = new Document("OrderManager.docOMProvEMA");
                                                                      var param = new Document("OrderManager.docOMParamEMA");


                                                                      if(resp==null || resp.estado=="NOOK"){
                                                                           this.process.processDocument.CTRL_ERROR = "11";
                                                                           this.process.processDocument.CTRL_DESC_ERROR = "Error 11: Error al provisionar en EMA. EMA responde: " + resp.mensaje;
                                                                           OrderManager.actualizaEstadoOrden(this.process.processDocument.IN_orderId, "ErrorEMA", "Error 11: Error al provisionar en EMA. EMA responde: " + resp.mensaje, "", this.process.processDocument.IN_POIdBasico);
                                                                          this.process.processDocument.OUT_estadoOrden = "ErrorEMA";

                                                                           //Ingreso un registro en la tabla de provision
                                                                           prov.orderId = docProc.IN_orderId;
                                                                           prov.POId = docProc.IN_POIdBasico;
                                                                           prov.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                                                           prov.estado = "11";
                                                                           prov.motivoEstado = "Error al provisionar en EMA. EMA responde: " + resp.mensaje;
                                                                           prov.save();

                                                                           //Ingreso un registro con los parámetros que se utilizaron
                                                                           param.orderId = docProc.IN_orderId;
                                                                           param.POId = docProc.IN_POIdBasico;
                                                                           param.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                                                           param.paramId = "PROFILE";
                                                                           param.valor = docProc.CTRL_profile;
                                                                           param.save();

                                                                           return;
                                                                      }

                                                                      //Si no hubo error, guardo un registro en la tabla de provisión y en la tabla de parámetros con el (o los) parámetro utilizado (s)

                                                                       //Ingreso un registro en la tabla de provision
                                                                           prov.orderId = docProc.IN_orderId;
                                                                           prov.POId = docProc.IN_POIdBasico;
                                                                           prov.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                                                           prov.estado = "0";
                                                                           prov.motivoEstado = "Provisión en EMA ejecutada correctamente. EMA: " + resp.mensaje;
                                                                           prov.save();

                                                                           //Ingreso un registro con los parámetros que se utilizaron
                                                                           param.orderId = docProc.IN_orderId;
                                                                           param.POId = docProc.IN_POIdBasico;
                                                                           param.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                                                           param.paramId = "PROFILE";
                                                                           param.valor = docProc.CTRL_profile;
                                                                           param.save();


                                                                      var a=1;
                                                                    ]]></script>
                                                                  </method>
                                                                </methodList>
                                                              </child>
                                                            </childList>
                                                          </child>
                                                        </childList>
                                                        <methodList>
                                                          <method name="cwOnProcActCond" type="action">
                                                            <category>cond</category>
                                                            <system>true</system>
                                                            <script><![CDATA[return this.process.processDocument.CTRL_ERROR == "0";]]></script>
                                                          </method>
                                                        </methodList>
                                                      </child>
                                                    </childList>
                                                  </child>
                                                </childList>
                                                <methodList>
                                                  <method name="cwOnProcActAfter" type="action">
                                                    <category>script</category>
                                                    <system>true</system>
                                                    <script><![CDATA[
                                                      //OrderManager.debug();
                                                      //Inicializa las variables de control, que indican si hay algun problema en el flujo. Quedan en el processDocument.
                                                      var docProc = this.process.processDocument;
                                                      OrderManager.inicializaVariableControl(this.process.processDocument);

                                                      //resp contiene el resultado del WS, con la respuesta de la activación en CS
                                                      var resp = this.activityData;

                                                      var prov = new Document("OrderManager.docOMProvCS");
                                                      var param = new Document("OrderManager.docOMParamCS");


                                                      if(resp==null || resp.estado=="NOOK"){
                                                           this.process.processDocument.CTRL_ERROR = "9";
                                                           this.process.processDocument.CTRL_DESC_ERROR = "Error 9: Error al provisionar en CS. " + resp.mensaje;
                                                           OrderManager.actualizaEstadoOrden(this.process.processDocument.IN_orderId, "ErrorCS", "Error 9: Error al provisionar en CS. " + resp.mensaje, "", this.process.processDocument.IN_POIdBasico);
                                                           this.process.processDocument.OUT_estadoOrden = "ErrorCS";

                                                           //Ingreso un registro en la tabla de provision
                                                           prov.orderId = docProc.IN_orderId;
                                                           prov.POId = docProc.IN_POIdBasico;
                                                           prov.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                                           prov.estado = "9";
                                                           prov.motivoEstado = "Error al provisionar en CS. " + resp.mensaje;
                                                           prov.save();

                                                           //Ingreso un registro con los parámetros que se utilizaron
                                                           param.orderId = docProc.IN_orderId;
                                                           param.POId = docProc.IN_POIdBasico;
                                                           param.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                                           param.paramId = "ID_PLAN_CS";
                                                           param.valor = docProc.CTRL_planCS;
                                                           param.save();

                                                           return;
                                                      }

                                                      //Si no hubo error, guardo un registro en la tabla de provisión y en la tabla de parámetros con el (o los) parámetro utilizado (s)

                                                       //Ingreso un registro en la tabla de provision
                                                           prov.orderId = docProc.IN_orderId;
                                                           prov.POId = docProc.IN_POIdBasico;
                                                           prov.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                                           prov.estado = "0";
                                                           prov.motivoEstado = "Provisión en CS ejecutada correctamente. CS: " + resp.mensaje;
                                                           prov.save();

                                                           //Ingreso un registro con los parámetros que se utilizaron
                                                           param.orderId = docProc.IN_orderId;
                                                           param.POId = docProc.IN_POIdBasico;
                                                           param.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                                           param.paramId = "ID_PLAN_CS";
                                                           param.valor = docProc.CTRL_planCS;
                                                           param.save();


                                                      var a=1;
                                                    ]]></script>
                                                  </method>
                                                  <method name="cwOnProcActBefore" type="action">
                                                    <category>before</category>
                                                    <system>true</system>
                                                    <script><![CDATA[
                                                      //OrderManager.debug();

                                                      /** En esta sección, se deben completar los parámetros de entrada a la llamada del WS de provisión
                                                       *    de CS. En este caso, se requiere el MSISDN y el codigo del plan en CS.
                                                       */

                                                      this.activityData.orderid = this.process.processDocument.IN_orderId;
                                                      this.activityData.msisdn = this.process.processDocument.OUT_MSISDN;
                                                      this.activityData.id_plan_cs = this.process.processDocument.CTRL_planCS;
                                                      var a = 1;
                                                    ]]></script>
                                                  </method>
                                                </methodList>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                        <methodList>
                                          <method name="cwOnProcActCond" type="action">
                                            <category>cond</category>
                                            <system>true</system>
                                            <script><![CDATA[return this.process.processDocument.CTRL_ERROR == "0";]]></script>
                                          </method>
                                        </methodList>
                                      </child>
                                      <child name="nok" type="caseActivity">
                                        <label>nok</label>
                                        <x>572.0</x>
                                        <y>228.0</y>
                                        <childList>
                                          <child name="seqNotificar" type="seqActivity">
                                            <label>seqNotificar</label>
                                            <x>572.0</x>
                                            <y>228.0</y>
                                            <childList>
                                              <child name="notificarError" type="scriptActivity">
                                                <label>notificarError</label>
                                                <x>560.0</x>
                                                <y>318.0</y>
                                                <methodList>
                                                  <method name="cwOnProcActBefore" type="action">
                                                    <category>before</category>
                                                    <system>true</system>
                                                    <script><![CDATA[
                                                      OrderManager.debug();

                                                      OrderManager.notificaErrorEnProceso(this.process.processDocument);

                                                      return;
                                                    ]]></script>
                                                  </method>
                                                </methodList>
                                              </child>
                                              <child name="ordenNoCompletada" type="completeActivity">
                                                <label>ordenNoCompletada</label>
                                                <x>541.0</x>
                                                <y>412.0</y>
                                              </child>
                                            </childList>
                                          </child>
                                        </childList>
                                      </child>
                                    </childList>
                                  </child>
                                </childList>
                                <methodList>
                                  <method name="cwOnProcActAfter" type="action">
                                    <category>script</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      //OrderManager.debug();


                                      //Inicializa las variables de control, que indican si hay algun problema en el flujo. Quedan en el processDocument.
                                      var docProc = this.process.processDocument;
                                      OrderManager.inicializaVariableControl(this.process.processDocument);


                                      //resp contiene el resultado del WS, con la respuesta de la activación en BSCS
                                      var resp = this.activityData;

                                      var prov = new Document("OrderManager.docOMProvBSCS");
                                      var param = new Document("OrderManager.docOMParamBSCS");


                                      if(resp==null || resp.estado=="NOOK"){
                                           this.process.processDocument.CTRL_ERROR = "10";
                                           this.process.processDocument.CTRL_DESC_ERROR = "Error 10: Error al provisionar en BSCS. BSCS responde: " + resp.mensaje;
                                           this.process.processDocument.OUT_estadoOrden = "ErrorBSSC";
                                           OrderManager.actualizaEstadoOrden(this.process.processDocument.IN_orderId, "ErrorBSSC", "Error 10: Error al provisionar en BSCS. BSCS responde: " + resp.mensaje, "", this.process.processDocument.IN_POIdBasico);

                                           //Ingreso un registro en la tabla de provision
                                           prov.orderId = docProc.IN_orderId;
                                           prov.POId = docProc.IN_POIdBasico;
                                           prov.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                           prov.estado = "10";
                                           prov.motivoEstado = "Error 10: Error al provisionar en BSCS. BSCS responde: " + resp.mensaje;

                                           prov.save();

                                           //Ingreso un registro con los parámetros que se utilizaron
                                           param.orderId = docProc.IN_orderId;
                                           param.POId = docProc.IN_POIdBasico;
                                           param.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                           param.paramId = "ID_PLAN_BSCS";
                                           param.valor = docProc.CTRL_planBSCS;
                                           param.save();

                                           return;
                                      }

                                      //Si no hubo error, guardo un registro en la tabla de provisión y en la tabla de parámetros con el (o los) parámetro utilizado (s)

                                       //Ingreso un registro en la tabla de provision
                                           prov.orderId = docProc.IN_orderId;
                                           prov.POId = docProc.IN_POIdBasico;
                                           prov.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                           prov.estado = "0"; // 0 indica OK
                                           prov.motivoEstado = "Provisión en BSCS ejecutada correctamente. BSCS responde: " + resp.mensaje;
                                           prov.save();

                                           //Ingreso un registro con los parámetros que se utilizaron
                                           param.orderId = docProc.IN_orderId;
                                           param.POId = docProc.IN_POIdBasico;
                                           param.numIntento = 1; // por ahora queda fijo ya que no manejamos re-intentos
                                           param.paramId = "ID_PLAN_BSCS";
                                           param.valor = docProc.CTRL_planBSCS;
                                           param.save();


                                      var a=1;
                                    ]]></script>
                                  </method>
                                  <method name="cwOnProcActBefore" type="action">
                                    <category>before</category>
                                    <system>true</system>
                                    <script><![CDATA[
                                      //OrderManager.debug();
                                      this.activityData.orderid = this.process.processDocument.IN_orderId;
                                      this.activityData.rut = this.process.processDocument.IN_rut;
                                      this.activityData.msisdn = this.process.processDocument.OUT_MSISDN;
                                      this.activityData.id_plan_bscs = this.process.processDocument.CTRL_planBSCS;
                                      var a = 1;
                                    ]]></script>
                                  </method>
                                </methodList>
                              </child>
                            </childList>
                          </child>
                        </childList>
                        <methodList>
                          <method name="cwOnProcActCond" type="action">
                            <category>cond</category>
                            <system>true</system>
                            <script><![CDATA[return this.process.processDocument.CTRL_ERROR == "0";]]></script>
                          </method>
                        </methodList>
                      </child>
                    </childList>
                  </child>
                </childList>
                <methodList>
                  <method name="cwOnProcActAfter" type="action">
                    <category>script</category>
                    <system>true</system>
                    <script><![CDATA[
                      OrderManager.debug();
                      //Inicializa las variables de control, que indican si hay algun problema en el flujo. Quedan en el processDocument.
                      OrderManager.inicializaVariableControl(this.process.processDocument);

                      var docProc = this.process.processDocument;

                      //resp contiene el resultado del WS, con la respuesta del MSISDN
                      var resp = this.activityData;



                      /*************** Inicio de la creacion de la ORDEN **************************/
                      var orden = new Document("OrderManager.docOMOrden");  //documento asociado a la tabla de BD OM_ORDEN
                      var fnd = new Finder("OrderManager.finOM_Orden"); // finder del OM_ORDEN
                      var resultOM_Orden; //lista que retornara el finder

                      orden.orderId = this.process.processDocument.IN_orderId;

                      var resultOM_Orden = fnd.search(resultOM_Orden, orden);//retorna una DataObjectList() -> ARRAY
                      var doc = resultOM_Orden && resultOM_Orden.length>0 ? resultOM_Orden[0] : null;

                      //Si lo encuentra en BD, debe entregar ERROR, ya que siempre debe provisionar una orden nueva

                      //Descomentar estas dos lineas para exportar JAR
                      if(doc){
                          orden = doc;
                      //if(!doc){ //Descomentar estas dos lineas para probar local
                          orden.rut = docProc.IN_rut;
                          orden.estado = "En Proceso";
                          orden.motivoEstado = "La orden ha sido ingresada y se encuentra en proceso de creación."
                          orden.tipoOrden = docProc.IN_tipoOrden;
                          orden.save();
                      }
                      else{  // si no lo encuentra, lo crea

                          this.process.processDocument.CTRL_ERROR = "1";
                          this.process.processDocument.CTRL_DESC_ERROR = "Error 1: La orden entregada no existe en la base de datos";
                          this.process.processDocument.OUT_estadoOrden = "ErrorOrden";
                          return;
                      }

                      /************* Fin de la creación de la ORDEN ****************/



                      /************ Inicio de la creación del recurso MSISDN *********/

                      //Si es servicio de consulta de MSISDN no fue exitoso, responde error
                      if(resp.estado == "NOOK"){
                           this.process.processDocument.CTRL_ERROR = "2";
                           this.process.processDocument.CTRL_DESC_ERROR = "Error 2: Error al obtener un nuevo MSISDN desde BSCS. BSCS: " + resp.mensaje;
                           this.process.processDocument.OUT_estadoOrden = "ErrorMSISDN";
                           orden.estado = "ErrorMSISDN";
                           orden.motivoEstado = "Error 2: Error al obtener un nuevo MSISDN desde BSCS. BSCS: " + resp.mensaje;
                           orden.save();

                           return;
                      }
                      else{
                          //se valida el largo del MSISDN
                          if(resp.msisdn==null || resp.msisdn.length != 11){
                               this.process.processDocument.CTRL_ERROR = "3";
                               this.process.processDocument.CTRL_DESC_ERROR = "Error 3: El MSISDN entregado es nulo o no tiene el largo adecuado";
                               this.process.processDocument.OUT_estadoOrden = "ErrorMSISDN";
                               orden.estado = "ErrorMSISDN";
                               orden.motivoEstado = "Error 3: El MSISDN entregado es nulo o no tiene el largo adecuado";
                               orden.save();
                               return;
                          }
                      }

                      /********** Fin de la creación del resurso MSISDN *************/


                      /*INICIO ********* Inicio Creación de PO BASICA *****************/

                      var ordenPOBas = new Document("OrderManager.docOMOrdenPO");  //documento asociado a la tabla de BD OM_ORDEN

                      //Se valida que venga una PO Basica
                      if(docProc.IN_POIdBasico == null || docProc.IN_POIdBasico.length == 0  && docProc.IN_POIdBasico!="null" && docProc.IN_POIdBasico!="NULL"){
                           this.process.processDocument.CTRL_ERROR = "12";
                           this.process.processDocument.CTRL_DESC_ERROR = "Error 12: No viene una PO Básica para provisionar";
                           this.process.processDocument.OUT_estadoOrden = "ErrorPOBasica";
                           orden.estado = "ErrorPOBasica";
                           orden.motivoEstado = "Error 12: No viene una PO Básica para provisionar";
                           orden.save();
                           return;
                      }
                      //Como ya se validó que la orden no existía previamente, por integridad referencial la order_po tampoco existe, por lo que se crea directamente
                      ordenPOBas.POId = docProc.IN_POIdBasico;
                      ordenPOBas.orderId = docProc.IN_orderId;
                      ordenPOBas.cwDocId = orden.cwDocId;
                      ordenPOBas.estado = "Creada";
                      ordenPOBas.motivoEstado = "PO Creada exitosamente";
                      ordenPOBas.save();

                      /*FIN ********* Fin Creación de PO BASICA *****************/


                      /*INICIO ********* Inicio Creación de PO Adicional *****************/

                      var ordenPOAdi = new Document("OrderManager.docOMOrdenPO");  //documento asociado a la tabla de BD OM_ORDEN
                      var hayAdicional = false;
                      //Como ya se validó que la orden no existía previamente, por integridad referencial la order_po tampoco existe, por lo que se crea directamente

                      //Primero se valida que la PO adicional venga informada
                      if(docProc.IN_POIdAdicional!=null && docProc.IN_POIdAdicional.length > 0 && docProc.IN_POIdAdicional!="null" && docProc.IN_POIdAdicional!="NULL"){
                          //Se valida que no sea igual a la PO Basica
                          if(docProc.IN_POIdAdicional != docProc.IN_POIdBasico){
                              ordenPOAdi.POId = docProc.IN_POIdAdicional;
                              ordenPOAdi.cwDocId = orden.cwDocId;
                              ordenPOAdi.orderId = docProc.IN_orderId;
                              ordenPOAdi.estado = "Creada";
                              ordenPOAdi.motivoEstado = "PO Creada exitosamente";
                              ordenPOAdi.save();
                              hayAdicional = true;
                          }
                      }
                      /*FIN ********* Fin Creación de PO Adicional *****************/


                      /*INICIO ********* Inicio Creación del MSISDN *****************/

                      var recurso = new Document("OrderManager.docOMRecursosPO");  //documento asociado a la tabla de BD OM_ORDEN
                      //Como ya se validó que la orden no existía previamente, por integridad referencial la order_po tampoco existe, por lo que se crea directamente

                      //Primero se valida que la MSISDN venga informada
                      if(resp.msisdn!=null && resp.msisdn.length == 11){
                              recurso.POId = docProc.IN_POIdBasico;
                              recurso.orderId = docProc.IN_orderId;
                              recurso.resourceId = "MSISDN";
                              recurso.valor = resp.msisdn;
                              recurso.save();
                              docProc.OUT_MSISDN = resp.msisdn;
                      }

                      /*FIN ********* Fin Creación de MSISDN *****************/
                    ]]></script>
                  </method>
                  <method name="cwOnProcActBefore" type="action">
                    <category>before</category>
                    <system>true</system>
                    <script><![CDATA[
                      //OrderManager.debug();
                      this.activityData.orderid = this.process.processDocument.IN_orderId;
                      this.activityData.rut = this.process.processDocument.IN_rut;
                      var a = 1;
                    ]]></script>
                  </method>
                </methodList>
              </child>
            </childList>
            <methodList>
              <method name="cwOnProcActCond" type="action">
                <category>cond</category>
                <system>true</system>
                <script><![CDATA[return this.process.processDocument.CTRL_ERROR == "0";]]></script>
              </method>
            </methodList>
          </child>
          <child name="nok" type="caseActivity">
            <label>nok</label>
            <x>68.0</x>
            <y>442.0</y>
            <childList>
              <child name="seqNotificar" type="seqActivity">
                <label>seqNotificar</label>
                <x>82.0</x>
                <y>425.0</y>
                <childList>
                  <child name="notificarError" type="scriptActivity">
                    <label>notificarError</label>
                    <x>68.0</x>
                    <y>518.0</y>
                    <methodList>
                      <method name="cwOnProcActBefore" type="action">
                        <category>before</category>
                        <system>true</system>
                        <script><![CDATA[
                          OrderManager.debug();

                          OrderManager.notificaErrorEnProceso(this.process.processDocument);

                          return;
                        ]]></script>
                      </method>
                    </methodList>
                  </child>
                  <child name="ordenNoCompletada" type="completeActivity">
                    <label>ordenNoCompletada</label>
                    <x>48.0</x>
                    <y>613.0</y>
                  </child>
                </childList>
              </child>
            </childList>
          </child>
        </childList>
      </child>
      <child name="billingParticipant" type="participantActivity">
        <label>billingParticipant</label>
        <participant>part_BSCSNamespace.billingParticipant</participant>
        <x>284.0</x>
        <y>-38.0</y>
      </child>
      <child name="CSParticipant" type="participantActivity">
        <label>CSParticipant</label>
        <participant>part_CSProvisionInterface.CSParticipant</participant>
        <x>748.0</x>
        <y>-41.0</y>
      </child>
      <child name="EMAParticipant" type="participantActivity">
        <label>EMAParticipant</label>
        <participant>part_EMANamespace.EMAParticipant</participant>
        <x>1108.0</x>
        <y>-34.0</y>
      </child>
      <child name="OE_Participant" type="participantActivity">
        <label>OE_Participant</label>
        <participant>part_OENamespace.OE_Participant</participant>
        <x>1485.0</x>
        <y>-54.0</y>
      </child>
    </childList>
    <methodList>
      <method name="cwOnProcActBefore" type="action">
        <category>before</category>
        <system>true</system>
        <script><![CDATA[this.process.processDocument.OUT_estadoOrden = "En Proceso";]]></script>
      </method>
    </methodList>
  </activity>
  <curRevision>true</curRevision>
  <document>doc_OrderManager.docProcesoProvision</document>
  <label>OMProvisionProcess</label>
  <metaVersion>25</metaVersion>
  <priority>8</priority>
  <type>User</type>
</process>