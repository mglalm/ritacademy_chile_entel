<?xml version="1.0" encoding="UTF-8" ?>
<script name="OrderManager.actualizaEstadoOrden">
  <label>actualizaEstadoOrden</label>
  <metaVersion>25</metaVersion>
  <parameterList>
    <parameter name="orderId" type="rifp">
      <type>dtype_OrderManager.dtOrderId</type>
    </parameter>
    <parameter name="estado" type="rifp">
      <type>dtype_OrderManager.dtEstado</type>
    </parameter>
    <parameter name="descEstado" type="rifp">
      <type>dtype_OrderManager.dtMotivoEstado</type>
    </parameter>
    <parameter name="nodo" type="rifp">
      <type>dtype_OrderManager.dtIdNodo</type>
    </parameter>
    <parameter name="POId" type="rifp">
      <type>dtype_OrderManager.dtPOId</type>
    </parameter>
  </parameterList>
  <script><![CDATA[
    /*
     * Esta función actualiza el estado de una orden en la BD a partir del número de orden.
     * Si no existe la orden en la BS, no hace nada
     *
     * Actualiza en cascada los estados de la orden, la PO, y el nodo en caso de ocurrir un problema
     *
     * LA PO y el Nodo son opcionales, si vienen como un string vacío o nulo no hace nada
     *
     */

    //OrderManager.debug();

    //Primero la Orden
    var orden = new Document("OrderManager.docOMOrden");  //documento asociado a la tabla de BD OM_ORDEN
    var fnd = new Finder("OrderManager.finOM_Orden"); // finder del OM_ORDEN
    var resultOM_Orden; //lista que retornara el finder

    orden.orderId = orderId;

    var resultOM_Orden = fnd.search(resultOM_Orden, orden);//retorna una DataObjectList() -> ARRAY
    var doc = resultOM_Orden && resultOM_Orden.length>0 ? resultOM_Orden[0] : null;

    //Si lo encuentra en BD, debe entregar ERROR, ya que siempre debe provisionar una orden nueva
    if(doc){
        orden = doc;
        orden.estado = estado;
        orden.motivoEstado = descEstado;
        orden.save();
    }

    //si viene la PO
    if(POId != null && POId.length>0){

        var po = new Document("OrderManager.docOMOrdenPO");  //documento asociado a la tabla de BD OM_ORDEN_PO
        var fnd = new Finder("OrderManager.finOM_OrdenPO"); // finder del OM_ORDEN_PO
        var resultOM_OrdenPO; //lista que retornara el finder
        var ordenPO = new Document("OrderManager.docOMOrdenPO");

        ordenPO.orderId = orderId;
        ordenPO.POId = POId;


        var resultOM_OrdenPO = fnd.search(resultOM_OrdenPO, ordenPO);//retorna una DataObjectList() -> ARRAY
        var docPO = resultOM_OrdenPO && resultOM_OrdenPO.length>0 ? resultOM_OrdenPO[0] : null;

        //Si lo encuentra en BD, debe entregar ERROR, ya que siempre debe provisionar una orden nueva
        if(docPO){
            ordenPO = docPO;
            ordenPO.estado = estado;
            ordenPO.motivoEstado = descEstado;
            ordenPO.save();
        }
    }

    //si viene el nodo, actualizo el sistema que tuvo el problema(puede ser EMA, CS o BSCS)
    if(nodo != null && nodo.length > 0){
        //pendiente
    }
  ]]></script>
</script>